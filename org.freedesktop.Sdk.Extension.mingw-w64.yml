id: org.freedesktop.Sdk.Extension.mingw-w64
branch: "18.08"
build-extension: true
sdk: org.freedesktop.Sdk
runtime: org.freedesktop.Sdk
runtime-version: "18.08"
separate-locales: false
appstream-compose: false
sdk-extensions: []
build-options:
  prefix: /usr/lib/sdk/mingw-w64
  env:
    C_INCLUDE_PATH: /usr/lib/sdk/mingw-w64/include
    CPLUS_INCLUDE_PATH: /usr/lib/sdk/mingw-w64/include
  prepend-path: /usr/lib/sdk/mingw-w64/bin
  prepend-ld-library-path: /usr/lib/sdk/mingw-w64/lib
  prepend-pkg-config-path: /usr/lib/sdk/mingw-w64/lib/pkgconfig
  cflags: -O2 -g
  cflags-override: true
  cxxflags: -O2 -g
  cxxflags-override: true
  ldflags: -L/usr/lib/sdk/mingw-w64/lib
  ldflags-override: true
modules:

  # Binutils

  - name: binutils-x86_64
    build-options:
      config-opts:
        - --target=x86_64-w64-mingw32
    config-opts: &binutils_config_opts
      - --with-system-zlib
      - --enable-lto
      - --enable-plugins
      - --enable-deterministic-archives
      - --disable-nls
      - --disable-werror
    install-rule: install-strip
    builddir: true
    sources: &binutils_sources
      - type: archive
        url: "https://ftp.gnu.org/gnu/binutils/binutils-2.32.tar.gz"
        sha256: 9b0d97b3d30df184d302bced12f976aa1e5fbf4b0be696cdebc6cca30411a46e

  - name: binutils-i686
    build-options:
      config-opts:
        - --target=i686-w64-mingw32
    config-opts: *binutils_config_opts
    install-rule: install-strip
    builddir: true
    sources: *binutils_sources

  # Headers

  - name: mingw-w64-headers-x86_64
    build-options:
      config-opts:
        - --target=x86_64-w64-mingw32
        - --prefix=${FLATPAK_DEST}/x86_64-w64-mingw32
    config-opts: &mingw_headers_config_opts
      - --enable-sdk=all
      - --enable-secure-api
    builddir: true
    subdir: mingw-w64-headers
    sources: &mingw_src
      - type: archive
        url: "https://downloads.sourceforge.net/mingw-w64/mingw-w64-v7.0.0.tar.bz2"
        sha256: aa20dfff3596f08a7f427aab74315a6cb80c2b086b4a107ed35af02f9496b628

  - name: mingw-w64-headers-i686
    build-options:
      config-opts:
        - --target=i686-w64-mingw32
        - --prefix=${FLATPAK_DEST}/i686-w64-mingw32
    config-opts: *mingw_headers_config_opts
    builddir: true
    subdir: mingw-w64-headers
    sources: *mingw_src

  # GCC dependencies

  - name: mpc
    config-opts:
      - --enable-shared
      - --disable-static
    sources:
      - type: archive
        url: "https://ftp.gnu.org/gnu/mpc/mpc-1.1.0.tar.gz"
        sha256: 6985c538143c1208dcb1ac42cedad6ff52e267b47e5f970183a3e75125b43c2e
    modules:

      - name: mpfr
        config-opts:
          - --enable-shared
          - --disable-static
        sources:
          - type: archive
            url: "https://ftp.gnu.org/gnu/mpfr/mpfr-4.0.2.tar.gz"
            sha256: ae26cace63a498f07047a784cd3b0e4d010b44d2b193bab82af693de57a19a78

  # GCC bootstrap

  - name: gcc-bootstrap-x86_64
    build-options:
      config-opts:
        - --target=x86_64-w64-mingw32
    config-opts: &gcc_bootstrap_config_opts
      - --disable-multilib
      - --enable-languages=c,lto
      - --enable-lto
      - --with-system-zlib
      - --enable-static
      - --disable-sjlj-exceptions
      - --with-dwarf2
    make-args:
      - all-gcc
    install-rule: install-gcc
    builddir: true
    sources: &gcc_sources
      - type: archive
        url: "https://ftp.gnu.org/gnu/gcc/gcc-9.2.0/gcc-9.2.0.tar.xz"
        sha256: ea6ef08f121239da5695f76c9b33637a118dcf63e24164422231917fa61fb206

  - name: gcc-bootstrap-i686
    build-options:
      config-opts:
        - --target=i686-w64-mingw32
    config-opts: *gcc_bootstrap_config_opts
    make-args:
      - all-gcc
    install-rule: install-gcc
    builddir: true
    sources: *gcc_sources

  # MinGW CRT

  - name: mingw-w64-crt-x86_64
    build-options:
      config-opts:
        - --host=x86_64-w64-mingw32
        - --target=x86_64-w64-mingw32
        - --prefix=${FLATPAK_DEST}/x86_64-w64-mingw32
        - --disable-lib32
    builddir: true
    subdir: mingw-w64-crt
    sources: *mingw_src

  - name: mingw-w64-crt-i686
    build-options:
      config-opts:
        - --host=i686-w64-mingw32
        - --target=i686-w64-mingw32
        - --prefix=${FLATPAK_DEST}/i686-w64-mingw32
    builddir: true
    subdir: mingw-w64-crt
    sources: *mingw_src

  # MinGW winpthreads

  - name: mingw-w64-winpthreads-x86_64
    build-options:
      config-opts:
        - --host=x86_64-w64-mingw32
        - --prefix=${FLATPAK_DEST}/x86_64-w64-mingw32
    config-opts: &mingw_winpthreads_config_opts
      - --enable-static
      - --enable-shared
    builddir: true
    subdir: mingw-w64-libraries/winpthreads
    sources: *mingw_src

  - name: mingw-w64-winpthreads-i686
    build-options:
      config-opts:
        - --host=i686-w64-mingw32
        - --prefix=${FLATPAK_DEST}/i686-w64-mingw32
    config-opts: *mingw_winpthreads_config_opts
    builddir: true
    subdir: mingw-w64-libraries/winpthreads
    sources: *mingw_src

  # GCC full

  - name: gcc-x86_64
    build-options:
      config-opts:
        - --target=x86_64-w64-mingw32
    config-opts: &gcc_config_opts
      - --disable-multilib
      - --enable-languages=c,c++,lto
      - --enable-lto
      - --with-system-zlib
      - --enable-shared
      - --enable-static
      - --enable-threads=posix
      - --enable-libstdcxx-time=yes
      - --enable-libstdcxx-filesystem-ts=yes
      - --enable-libgomp
      - --disable-sjlj-exceptions
      - --with-dwarf2
    ensure-writable:
      - /lib/gcc/*/*/install-tools/*.conf
    install-rule: install-strip
    builddir: true
    sources: *gcc_sources

  - name: gcc-i686
    build-options:
      config-opts:
        - --target=i686-w64-mingw32
    config-opts: *gcc_config_opts
    ensure-writable:
      - /lib/gcc/*/*/install-tools/*.conf
    install-rule: install-strip
    builddir: true
    sources: *gcc_sources

  - name: bundle-setup
    buildsystem: simple
    build-commands:
      - install -Dm644 ${FLATPAK_ID}.metainfo.xml -t ${FLATPAK_DEST}/share/metainfo
      - appstream-compose --basename=${FLATPAK_ID} --prefix=${FLATPAK_DEST} --origin=flatpak ${FLATPAK_ID}
    sources:
      - type: file
        path: org.freedesktop.Sdk.Extension.mingw-w64.metainfo.xml
